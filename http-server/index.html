<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Home Controller</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }

        :root {
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f1f5f9;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border-color: #e2e8f0;
            --accent: #3b82f6;
            --accent-hover: #2563eb;
            --success: #22c55e;
            --danger: #ef4444;
            --warning: #f59e0b;
        }

        .dark {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border-color: #334155;
            --accent: #60a5fa;
            --accent-hover: #3b82f6;
        }

        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }

        .card {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
        }

        .text-secondary {
            color: var(--text-secondary);
        }

        .bg-tertiary {
            background-color: var(--bg-tertiary);
        }

        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 5px rgba(34, 197, 94, 0.5); }
            50% { box-shadow: 0 0 20px rgba(34, 197, 94, 0.8); }
        }

        @keyframes pulse-glow-off {
            0%, 100% { box-shadow: 0 0 5px rgba(239, 68, 68, 0.5); }
            50% { box-shadow: 0 0 20px rgba(239, 68, 68, 0.8); }
        }

        .relay-on {
            animation: pulse-glow 2s infinite;
        }

        .relay-off {
            animation: pulse-glow-off 2s infinite;
        }

        @keyframes pulse-glow-yellow {
            0%, 100% { box-shadow: 0 0 5px rgba(234, 179, 8, 0.5); }
            50% { box-shadow: 0 0 25px rgba(234, 179, 8, 0.9); }
        }

        .led-on {
            animation: pulse-glow-yellow 1.5s infinite;
        }

        .led-off {
            box-shadow: 0 0 5px rgba(100, 116, 139, 0.3);
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-in {
            animation: fadeInUp 0.5s ease-out forwards;
        }

        .animate-delay-1 { animation-delay: 0.1s; }
        .animate-delay-2 { animation-delay: 0.2s; }
        .animate-delay-3 { animation-delay: 0.3s; }

        @keyframes spin-slow {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .animate-spin-slow {
            animation: spin-slow 3s linear infinite;
        }

        @keyframes bounce-subtle {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        .hover-bounce:hover {
            animation: bounce-subtle 0.5s ease-in-out;
        }

        .metric-card {
            opacity: 0;
        }

        .switch {
            position: relative;
            width: 80px;
            height: 40px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--danger);
            transition: 0.4s;
            border-radius: 40px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 32px;
            width: 32px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--success);
        }

        input:checked + .slider:before {
            transform: translateX(40px);
        }

        .progress-ring {
            transform: rotate(-90deg);
        }

        .progress-ring__circle {
            transition: stroke-dashoffset 0.5s ease;
        }

        @keyframes data-pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .data-updating {
            animation: data-pulse 0.5s ease-in-out;
        }

        .glass {
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .gradient-border {
            position: relative;
            background: var(--bg-secondary);
            border-radius: 1rem;
        }

        .gradient-border::before {
            content: '';
            position: absolute;
            inset: -2px;
            border-radius: 1rem;
            padding: 2px;
            background: linear-gradient(135deg, var(--accent), var(--success), var(--warning));
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .gradient-border:hover::before {
            opacity: 1;
        }
    </style>
</head>
<body class="font-sans">
    <div class="min-h-screen p-4 md:p-8">
        <!-- Header -->
        <header class="max-w-6xl mx-auto mb-8 animate-fade-in">
            <div class="card rounded-2xl p-6 flex flex-col md:flex-row items-center justify-between gap-4">
                <div class="flex items-center gap-4">
                    <div class="w-14 h-14 rounded-xl bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center">
                        <i class="fas fa-home text-white text-2xl"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl md:text-3xl font-bold bg-gradient-to-r from-blue-500 to-purple-600 bg-clip-text text-transparent">
                            Smart Home Controller
                        </h1>
                        <p class="text-secondary text-sm">MQTT-based IoT Dashboard</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <div id="connectionStatus" class="flex items-center gap-2 px-4 py-2 rounded-full bg-tertiary">
                        <span class="w-3 h-3 rounded-full bg-yellow-500 animate-pulse"></span>
                        <span class="text-sm font-medium">Connecting...</span>
                    </div>
                    <button id="themeToggle" class="w-12 h-12 rounded-xl bg-tertiary hover:bg-opacity-80 flex items-center justify-center hover-bounce" onclick="toggleTheme()">
                        <i class="fas fa-moon text-xl" id="themeIcon"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-6xl mx-auto">
            <!-- Relay Control Section -->
            <section class="mb-8 animate-fade-in animate-delay-1">
                <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
                    <i class="fas fa-plug text-accent"></i>
                    Relay Control
                </h2>
                <div class="card rounded-2xl p-8 gradient-border">
                    <div class="flex flex-col md:flex-row items-center justify-between gap-8">
                        <div class="flex items-center gap-6">
                            <div id="relayIndicator" class="w-24 h-24 rounded-full bg-red-500/20 flex items-center justify-center relay-off">
                                <i class="fas fa-power-off text-4xl text-red-500" id="relayIcon"></i>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold">Room Relay</h3>
                                <p class="text-secondary" id="relayStatus">Status: OFF</p>
                                <p class="text-secondary text-sm" id="lastCommand">Last command: None</p>
                            </div>
                        </div>
                        <div class="flex flex-col items-center gap-4">
                            <label class="switch">
                                <input type="checkbox" id="relayToggle" onchange="toggleRelay()">
                                <span class="slider"></span>
                            </label>
                            <span class="text-sm text-secondary">Toggle Relay</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Room LED Control Section -->
            <section class="mb-8 animate-fade-in animate-delay-1">
                <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
                    <i class="fas fa-lightbulb text-yellow-500"></i>
                    Room LED Control
                    <span class="text-xs bg-tertiary px-2 py-1 rounded-full text-secondary ml-2">Ultrasonic + LDR Controlled</span>
                </h2>
                <div class="card rounded-2xl p-8 gradient-border">
                    <div class="flex flex-col lg:flex-row items-center justify-between gap-8">
                        <!-- LED Status -->
                        <div class="flex items-center gap-6">
                            <div id="ledIndicator" class="w-24 h-24 rounded-full bg-gray-500/20 flex items-center justify-center led-off">
                                <i class="fas fa-lightbulb text-4xl text-gray-500" id="ledIcon"></i>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold">Room LED</h3>
                                <p class="text-secondary" id="ledStatus">Status: OFF</p>
                                <p class="text-secondary text-sm" id="ledMode">Mode: Automatic (Sensor Control)</p>
                                <p class="text-secondary text-sm" id="lastLedCommand">Last command: None</p>
                            </div>
                        </div>
                        
                        <!-- Controls -->
                        <div class="flex flex-col sm:flex-row items-center gap-8">
                            <!-- Manual Mode Toggle -->
                            <div class="flex flex-col items-center gap-3">
                                <div class="relative">
                                    <label class="switch">
                                        <input type="checkbox" id="manualModeToggle" onchange="toggleManualMode()">
                                        <span class="slider" style="background-color: var(--text-secondary);"></span>
                                    </label>
                                </div>
                                <div class="text-center">
                                    <span class="text-sm font-medium" id="manualModeLabel">Manual Mode</span>
                                    <p class="text-xs text-secondary mt-1" id="manualModeDesc">Sensors controlling LED</p>
                                </div>
                            </div>
                            
                            <!-- Divider -->
                            <div class="hidden sm:block w-px h-20 bg-tertiary"></div>
                            
                            <!-- LED Toggle (only active in manual mode) -->
                            <div class="flex flex-col items-center gap-3" id="ledControlContainer">
                                <label class="switch">
                                    <input type="checkbox" id="ledToggle" onchange="toggleLED()" disabled>
                                    <span class="slider" id="ledSlider" style="opacity: 0.5; cursor: not-allowed;"></span>
                                </label>
                                <div class="text-center">
                                    <span class="text-sm font-medium">LED Power</span>
                                    <p class="text-xs text-secondary mt-1" id="ledControlDesc">Enable manual mode first</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Info Banner -->
                    <div id="ledInfoBanner" class="mt-6 p-4 rounded-xl bg-blue-500/10 border border-blue-500/20 flex items-start gap-3">
                        <i class="fas fa-info-circle text-blue-500 mt-0.5"></i>
                        <div>
                            <p class="text-sm font-medium text-blue-500">Automatic Mode Active</p>
                            <p class="text-xs text-secondary mt-1">The LED is being controlled by ultrasonic sensors and LDR. Enable manual mode to override sensor control.</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Metrics Section -->
            <section class="animate-fade-in animate-delay-2">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-semibold flex items-center gap-2">
                        <i class="fas fa-chart-line text-accent"></i>
                        Live Metrics
                    </h2>
                    <div class="flex items-center gap-2 text-secondary text-sm">
                        <i class="fas fa-sync-alt animate-spin-slow" id="syncIcon"></i>
                        <span id="lastUpdate">Waiting for data...</span>
                    </div>
                </div>
                
                <div id="metricsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Metrics cards will be dynamically inserted here -->
                    <div class="card rounded-2xl p-6 text-center">
                        <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-tertiary flex items-center justify-center">
                            <i class="fas fa-satellite-dish text-2xl text-secondary animate-pulse"></i>
                        </div>
                        <p class="text-secondary">Waiting for metrics data...</p>
                        <p class="text-sm text-secondary mt-2">Make sure your MQTT sensors are publishing to:</p>
                        <code class="text-xs bg-tertiary px-2 py-1 rounded mt-2 inline-block">myhome/room/metrics</code>
                    </div>
                </div>
            </section>

            <!-- Activity Log -->
            <section class="mt-8 animate-fade-in animate-delay-3">
                <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
                    <i class="fas fa-history text-accent"></i>
                    Activity Log
                </h2>
                <div class="card rounded-2xl p-6 max-h-64 overflow-y-auto">
                    <div id="activityLog" class="space-y-2">
                        <div class="flex items-center gap-3 p-3 bg-tertiary rounded-lg">
                            <i class="fas fa-info-circle text-blue-500"></i>
                            <span class="text-sm">Dashboard initialized</span>
                            <span class="text-xs text-secondary ml-auto" id="initTime"></span>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <!-- Footer -->
        <footer class="max-w-6xl mx-auto mt-12 text-center text-secondary text-sm">
            <p>Smart Home Controller &copy; 2024 | MQTT Broker: broker.hivemq.com</p>
        </footer>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-4 right-4 transform translate-y-20 opacity-0 transition-all duration-300 z-50">
        <div class="card rounded-xl p-4 shadow-2xl flex items-center gap-3">
            <i class="fas fa-check-circle text-green-500 text-xl" id="toastIcon"></i>
            <span id="toastMessage">Notification</span>
        </div>
    </div>

    <script>
        // State
        let isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;
        let relayState = false;
        let ledState = false;
        let manualMode = false;
        let metrics = {};
        let syncInterval = 1000; // Sync every 1 second

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initTheme();
            document.getElementById('initTime').textContent = new Date().toLocaleTimeString();
            startMetricsSync();
            fetchState();
            setInterval(fetchState, 2000); // Sync state every 2 seconds
        });

        // Fetch LED and Manual Mode state from server
        async function fetchState() {
            try {
                const response = await fetch('/state');
                const data = await response.json();
                
                if (data.ledState !== ledState) {
                    ledState = data.ledState;
                    updateLedUI();
                }
                if (data.manualMode !== manualMode) {
                    manualMode = data.manualMode;
                    updateManualModeUI();
                }
            } catch (error) {
                console.error('Failed to fetch state:', error);
            }
        }

        // LED Control
        async function sendLEDCommand(state) {
            try {
                const response = await fetch(`/led/${state}`);
                const text = await response.text();
                
                ledState = state === 'on';
                updateLedUI();
                addActivityLog(`LED turned ${state.toUpperCase()}`, state === 'on' ? 'success' : 'warning');
                showToast(`LED ${state.toUpperCase()} command sent`, 'success');
                
                document.getElementById('lastLedCommand').textContent = `Last command: ${state.toUpperCase()} at ${new Date().toLocaleTimeString()}`;
            } catch (error) {
                showToast('Failed to send LED command', 'error');
                addActivityLog('Failed to send LED command', 'error');
            }
        }

        function toggleLED() {
            const toggle = document.getElementById('ledToggle');
            sendLEDCommand(toggle.checked ? 'on' : 'off');
        }

        function updateLedUI() {
            const indicator = document.getElementById('ledIndicator');
            const icon = document.getElementById('ledIcon');
            const status = document.getElementById('ledStatus');
            const toggle = document.getElementById('ledToggle');

            if (ledState) {
                indicator.className = 'w-24 h-24 rounded-full bg-yellow-500/20 flex items-center justify-center led-on';
                icon.className = 'fas fa-lightbulb text-4xl text-yellow-500';
                status.textContent = 'Status: ON';
                toggle.checked = true;
            } else {
                indicator.className = 'w-24 h-24 rounded-full bg-gray-500/20 flex items-center justify-center led-off';
                icon.className = 'fas fa-lightbulb text-4xl text-gray-500';
                status.textContent = 'Status: OFF';
                toggle.checked = false;
            }
        }

        // Manual Mode Control
        async function sendManualModeCommand(state) {
            try {
                const response = await fetch(`/manual/${state}`);
                const text = await response.text();
                
                manualMode = state === 'on';
                updateManualModeUI();
                
                const modeText = manualMode ? 'Manual Override' : 'Automatic (Sensor Control)';
                addActivityLog(`LED mode changed to ${modeText}`, 'info');
                showToast(`Mode: ${modeText}`, 'info');
            } catch (error) {
                showToast('Failed to change mode', 'error');
                addActivityLog('Failed to change LED mode', 'error');
                // Revert toggle
                document.getElementById('manualModeToggle').checked = manualMode;
            }
        }

        function toggleManualMode() {
            const toggle = document.getElementById('manualModeToggle');
            sendManualModeCommand(toggle.checked ? 'on' : 'off');
        }

        function updateManualModeUI() {
            const toggle = document.getElementById('manualModeToggle');
            const ledToggle = document.getElementById('ledToggle');
            const ledSlider = document.getElementById('ledSlider');
            const ledControlDesc = document.getElementById('ledControlDesc');
            const manualModeDesc = document.getElementById('manualModeDesc');
            const ledMode = document.getElementById('ledMode');
            const infoBanner = document.getElementById('ledInfoBanner');
            const manualSlider = toggle.nextElementSibling;

            toggle.checked = manualMode;

            if (manualMode) {
                // Manual mode ON - enable LED control
                ledToggle.disabled = false;
                ledSlider.style.opacity = '1';
                ledSlider.style.cursor = 'pointer';
                ledControlDesc.textContent = 'Control LED manually';
                manualModeDesc.textContent = 'Override active';
                ledMode.textContent = 'Mode: Manual Override';
                manualSlider.style.backgroundColor = '';
                
                // Update info banner
                infoBanner.className = 'mt-6 p-4 rounded-xl bg-yellow-500/10 border border-yellow-500/20 flex items-start gap-3';
                infoBanner.innerHTML = `
                    <i class="fas fa-hand-pointer text-yellow-500 mt-0.5"></i>
                    <div>
                        <p class="text-sm font-medium text-yellow-500">Manual Mode Active</p>
                        <p class="text-xs text-secondary mt-1">You have full control over the LED. Ultrasonic sensors and LDR readings are ignored. Disable manual mode to return to automatic control.</p>
                    </div>
                `;
            } else {
                // Manual mode OFF - disable LED control
                ledToggle.disabled = true;
                ledSlider.style.opacity = '0.5';
                ledSlider.style.cursor = 'not-allowed';
                ledControlDesc.textContent = 'Enable manual mode first';
                manualModeDesc.textContent = 'Sensors controlling LED';
                ledMode.textContent = 'Mode: Automatic (Sensor Control)';
                manualSlider.style.backgroundColor = 'var(--text-secondary)';
                
                // Update info banner
                infoBanner.className = 'mt-6 p-4 rounded-xl bg-blue-500/10 border border-blue-500/20 flex items-start gap-3';
                infoBanner.innerHTML = `
                    <i class="fas fa-info-circle text-blue-500 mt-0.5"></i>
                    <div>
                        <p class="text-sm font-medium text-blue-500">Automatic Mode Active</p>
                        <p class="text-xs text-secondary mt-1">The LED is being controlled by ultrasonic sensors and LDR. Enable manual mode to override sensor control.</p>
                    </div>
                `;
            }
        }

        // Theme Management
        function initTheme() {
            if (isDarkMode) {
                document.documentElement.classList.add('dark');
                document.getElementById('themeIcon').className = 'fas fa-sun text-xl';
            }
        }

        function toggleTheme() {
            isDarkMode = !isDarkMode;
            document.documentElement.classList.toggle('dark');
            const icon = document.getElementById('themeIcon');
            icon.className = isDarkMode ? 'fas fa-sun text-xl' : 'fas fa-moon text-xl';
            showToast(isDarkMode ? 'Dark mode enabled' : 'Light mode enabled', 'info');
        }

        // Relay Control
        async function sendRelayCommand(state) {
            try {
                const response = await fetch(`/relay/${state}`);
                const text = await response.text();
                
                relayState = state === 'on';
                updateRelayUI();
                addActivityLog(`Relay turned ${state.toUpperCase()}`, state === 'on' ? 'success' : 'warning');
                showToast(`Relay ${state.toUpperCase()} command sent`, 'success');
                
                document.getElementById('lastCommand').textContent = `Last command: ${state.toUpperCase()} at ${new Date().toLocaleTimeString()}`;
            } catch (error) {
                showToast('Failed to send command', 'error');
                addActivityLog('Failed to send relay command', 'error');
            }
        }

        function toggleRelay() {
            const toggle = document.getElementById('relayToggle');
            sendRelayCommand(toggle.checked ? 'on' : 'off');
        }

        function updateRelayUI() {
            const indicator = document.getElementById('relayIndicator');
            const icon = document.getElementById('relayIcon');
            const status = document.getElementById('relayStatus');
            const toggle = document.getElementById('relayToggle');

            if (relayState) {
                indicator.className = 'w-24 h-24 rounded-full bg-green-500/20 flex items-center justify-center relay-on';
                icon.className = 'fas fa-power-off text-4xl text-green-500';
                status.textContent = 'Status: ON';
                toggle.checked = true;
            } else {
                indicator.className = 'w-24 h-24 rounded-full bg-red-500/20 flex items-center justify-center relay-off';
                icon.className = 'fas fa-power-off text-4xl text-red-500';
                status.textContent = 'Status: OFF';
                toggle.checked = false;
            }
        }

        // Metrics Sync
        function startMetricsSync() {
            fetchMetrics();
            setInterval(fetchMetrics, syncInterval);
        }

        async function fetchMetrics() {
            try {
                const response = await fetch('/metrics');
                const data = await response.json();
                
                updateConnectionStatus(true);
                
                if (JSON.stringify(data) !== JSON.stringify(metrics)) {
                    metrics = data;
                    renderMetrics();
                    document.getElementById('lastUpdate').textContent = `Last update: ${new Date().toLocaleTimeString()}`;
                    
                    // Sync Relay status from metrics
                    if (data.Relay !== undefined && data.Relay !== relayState) {
                        relayState = data.Relay;
                        updateRelayUI();
                    }
                    
                    // Sync LED status from metrics (ESP32 sends "LED2")
                    if (data.LED2 !== undefined && data.LED2 !== ledState) {
                        ledState = data.LED2;
                        updateLedUI();
                    }
                    
                    // Sync Manual Mode from metrics
                    if (data.ManualMode !== undefined && data.ManualMode !== manualMode) {
                        manualMode = data.ManualMode;
                        updateManualModeUI();
                    }
                }
            } catch (error) {
                updateConnectionStatus(false);
            }
        }

        function updateConnectionStatus(connected) {
            const status = document.getElementById('connectionStatus');
            if (connected) {
                status.innerHTML = `
                    <span class="w-3 h-3 rounded-full bg-green-500"></span>
                    <span class="text-sm font-medium">Connected</span>
                `;
            } else {
                status.innerHTML = `
                    <span class="w-3 h-3 rounded-full bg-red-500 animate-pulse"></span>
                    <span class="text-sm font-medium">Disconnected</span>
                `;
            }
        }

        // Track which cards have been created
        let renderedKeys = new Set();

        function renderMetrics() {
            const grid = document.getElementById('metricsGrid');
            const keys = Object.keys(metrics);
            
            if (keys.length === 0) return;

            // Check if we need to create new cards (new keys appeared)
            const newKeys = keys.filter(k => !renderedKeys.has(k));
            
            if (newKeys.length > 0 || renderedKeys.size === 0) {
                // Initial render or new sensors added - create all cards
                grid.innerHTML = keys.map((key, index) => {
                    const value = metrics[key];
                    const { icon, color, unit } = getMetricMeta(key, value);
                    renderedKeys.add(key);
                    
                    return `
                        <div class="metric-card card rounded-2xl p-6 gradient-border animate-fade-in" data-metric-key="${key}" style="animation-delay: ${index * 0.1}s">
                            <div class="flex items-start justify-between mb-4">
                                <div class="w-12 h-12 rounded-xl ${color} bg-opacity-20 flex items-center justify-center">
                                    <i class="fas ${icon} text-xl ${color.replace('bg-', 'text-').replace('/20', '')}"></i>
                                </div>
                                <span class="text-xs text-secondary bg-tertiary px-2 py-1 rounded-full">Live</span>
                            </div>
                            <h3 class="text-secondary text-sm font-medium capitalize mb-1">${formatKey(key)}</h3>
                            <div class="flex items-baseline gap-2">
                                <span class="text-3xl font-bold metric-value" data-key="${key}">${formatValue(value)}</span>
                                <span class="text-secondary text-sm">${unit}</span>
                            </div>
                            ${renderMetricBar(key, value)}
                        </div>
                    `;
                }).join('');
            } else {
                // Just update values - no DOM recreation
                updateMetricValues();
            }
        }

        function updateMetricValues() {
            Object.keys(metrics).forEach(key => {
                const valueEl = document.querySelector(`.metric-value[data-key="${key}"]`);
                if (valueEl) {
                    const newValue = formatValue(metrics[key]);
                    if (valueEl.textContent !== newValue) {
                        valueEl.textContent = newValue;
                        // Add pulse animation on value change
                        valueEl.classList.remove('data-updating');
                        void valueEl.offsetWidth; // Trigger reflow
                        valueEl.classList.add('data-updating');
                    }
                }
                
                // Update progress bar if exists
                const card = document.querySelector(`[data-metric-key="${key}"]`);
                if (card) {
                    const barContainer = card.querySelector('.h-2.bg-tertiary');
                    if (barContainer) {
                        const bar = barContainer.querySelector('div');
                        if (bar) {
                            const keyLower = key.toLowerCase();
                            const value = metrics[key];
                            let percentage = 0;
                            let colorClass = 'bg-blue-500';
                            
                            if (keyLower.includes('humid') || keyLower === 'hum') {
                                percentage = Math.min(100, value);
                                colorClass = value > 70 ? 'bg-red-500' : value > 30 ? 'bg-green-500' : 'bg-yellow-500';
                            } else if (keyLower.includes('temp')) {
                                percentage = Math.min(100, Math.max(0, (value + 10) / 60 * 100));
                                colorClass = value > 30 ? 'bg-red-500' : value > 15 ? 'bg-green-500' : 'bg-blue-500';
                            }
                            
                            bar.style.width = `${percentage}%`;
                            bar.className = `${colorClass} h-full rounded-full transition-all duration-500`;
                        }
                    }
                }
            });
        }

        function getMetricMeta(key, value) {
            const keyLower = key.toLowerCase();
            
            if (keyLower === 'ldr') {
                return { icon: 'fa-lightbulb', color: 'bg-yellow-500/20', unit: 'LUX' };
            } else if (keyLower === 'dist1') {
                return { icon: 'fa-wave-square', color: 'bg-cyan-500/20', unit: 'cm' };
            } else if (keyLower === 'dist2') {
                return { icon: 'fa-wave-square', color: 'bg-teal-500/20', unit: 'cm' };
            } else if (keyLower === 'hum') {
                return { icon: 'fa-droplet', color: 'bg-blue-500/20', unit: '%' };
            } else if (keyLower === 'count') {
                return { icon: 'fa-users', color: 'bg-indigo-500/20', unit: 'people' };
            } else if (keyLower === 'mq2') {
                return { icon: 'fa-smog', color: 'bg-gray-500/20', unit: 'ppm' };
            } else if (keyLower === 'relay') {
                return { icon: 'fa-plug-circle-bolt', color: 'bg-green-500/20', unit: '' };
            } else if (keyLower === 'led2' || keyLower === 'roomled') {
                return { icon: 'fa-lightbulb', color: 'bg-amber-500/20', unit: '' };
            } else if (keyLower === 'manualmode') {
                return { icon: 'fa-hand', color: 'bg-purple-500/20', unit: '' };
            } else if (keyLower.includes('temp')) {
                return { icon: 'fa-temperature-high', color: 'bg-orange-500/20', unit: 'Â°C' };
            } else if (keyLower.includes('humid')) {
                return { icon: 'fa-droplet', color: 'bg-blue-500/20', unit: '%' };
            } else if (keyLower.includes('press')) {
                return { icon: 'fa-gauge-high', color: 'bg-purple-500/20', unit: 'hPa' };
            } else if (keyLower.includes('light') || keyLower.includes('lux')) {
                return { icon: 'fa-sun', color: 'bg-yellow-500/20', unit: 'LUX' };
            } else if (keyLower.includes('power') || keyLower.includes('watt')) {
                return { icon: 'fa-bolt', color: 'bg-green-500/20', unit: 'W' };
            } else if (keyLower.includes('volt')) {
                return { icon: 'fa-plug', color: 'bg-red-500/20', unit: 'V' };
            } else if (keyLower.includes('current') || keyLower.includes('amp')) {
                return { icon: 'fa-wave-square', color: 'bg-cyan-500/20', unit: 'A' };
            } else if (keyLower.includes('co2')) {
                return { icon: 'fa-cloud', color: 'bg-gray-500/20', unit: 'ppm' };
            } else if (keyLower.includes('motion') || keyLower.includes('pir')) {
                return { icon: 'fa-person-walking', color: 'bg-pink-500/20', unit: '' };
            } else if (keyLower.includes('door') || keyLower.includes('window')) {
                return { icon: 'fa-door-open', color: 'bg-indigo-500/20', unit: '' };
            } else if (typeof value === 'boolean') {
                return { icon: 'fa-toggle-on', color: 'bg-teal-500/20', unit: '' };
            }
            
            return { icon: 'fa-chart-simple', color: 'bg-slate-500/20', unit: '' };
        }

        function formatKey(key) {
            const keyLower = key.toLowerCase();
            
            // Custom labels for specific sensors
            const labelMap = {
                'ldr': 'Illumination',
                'dist1': 'Ultrasonic Sensor 1',
                'dist2': 'Ultrasonic Sensor 2',
                'hum': 'Humidity',
                'count': 'People Count',
                'mq2': 'Gas/Smoke',
                'temp': 'Temperature',
                'relay': 'Relay Status',
                'led2': 'Room LED Status',
                'roomled': 'Room LED Status',
                'manualmode': 'Manual Mode'
            };
            
            if (labelMap[keyLower]) {
                return labelMap[keyLower];
            }
            
            return key.replace(/_/g, ' ').replace(/([A-Z])/g, ' $1').trim();
        }

        function formatValue(value) {
            if (typeof value === 'number') {
                return value.toFixed(value % 1 === 0 ? 0 : 1);
            } else if (typeof value === 'boolean') {
                return value ? 'ON' : 'OFF';
            }
            return value;
        }

        function renderMetricBar(key, value) {
            if (typeof value !== 'number') return '';
            
            const keyLower = key.toLowerCase();
            let percentage = 0;
            let color = 'bg-blue-500';
            
            if (keyLower.includes('humid')) {
                percentage = Math.min(100, value);
                color = value > 70 ? 'bg-red-500' : value > 30 ? 'bg-green-500' : 'bg-yellow-500';
            } else if (keyLower.includes('temp')) {
                percentage = Math.min(100, Math.max(0, (value + 10) / 60 * 100));
                color = value > 30 ? 'bg-red-500' : value > 15 ? 'bg-green-500' : 'bg-blue-500';
            } else {
                return '';
            }
            
            return `
                <div class="mt-4">
                    <div class="h-2 bg-tertiary rounded-full overflow-hidden">
                        <div class="${color} h-full rounded-full transition-all duration-500" style="width: ${percentage}%"></div>
                    </div>
                </div>
            `;
        }

        // Activity Log
        function addActivityLog(message, type = 'info') {
            const log = document.getElementById('activityLog');
            const iconMap = {
                success: 'fa-check-circle text-green-500',
                warning: 'fa-exclamation-triangle text-yellow-500',
                error: 'fa-times-circle text-red-500',
                info: 'fa-info-circle text-blue-500'
            };
            
            const entry = document.createElement('div');
            entry.className = 'flex items-center gap-3 p-3 bg-tertiary rounded-lg animate-fade-in';
            entry.innerHTML = `
                <i class="fas ${iconMap[type]}"></i>
                <span class="text-sm">${message}</span>
                <span class="text-xs text-secondary ml-auto">${new Date().toLocaleTimeString()}</span>
            `;
            
            log.insertBefore(entry, log.firstChild);
            
            // Keep only last 20 entries
            while (log.children.length > 20) {
                log.removeChild(log.lastChild);
            }
        }

        // Toast Notification
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toastIcon');
            const msg = document.getElementById('toastMessage');
            
            const iconMap = {
                success: 'fa-check-circle text-green-500',
                error: 'fa-times-circle text-red-500',
                warning: 'fa-exclamation-triangle text-yellow-500',
                info: 'fa-info-circle text-blue-500'
            };
            
            icon.className = `fas ${iconMap[type]} text-xl`;
            msg.textContent = message;
            
            toast.classList.remove('translate-y-20', 'opacity-0');
            toast.classList.add('translate-y-0', 'opacity-100');
            
            setTimeout(() => {
                toast.classList.add('translate-y-20', 'opacity-0');
                toast.classList.remove('translate-y-0', 'opacity-100');
            }, 3000);
        }
    </script>
</body>
</html>
