name: CI/CD Pipeline (Pass Env Vars Remotely)

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Set dynamic image tag
        run: echo "TAG=v1.0.${{ github.run_number }}" >> $GITHUB_ENV

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./http-server
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/esp32-smart-home:${{ env.TAG }}

      # -------------------------------------------------------------------
      # FIXED: Use correct compose path + safe image replacement
      # -------------------------------------------------------------------
      - name: Prepare updated compose file content
        id: prepare_compose
        run: |
          # Path updated: using root-level docker-compose.yml
          COMPOSE_FILE="docker-compose.yml"

          if [ ! -f "$COMPOSE_FILE" ]; then
            echo "ERROR: $COMPOSE_FILE does not exist"
            exit 1
          fi

          COMPOSE_CONTENT=$(sed -E "s|(image:.*esp32-smart-home:).*|\1${{ env.TAG }}|" "$COMPOSE_FILE")

          echo "$COMPOSE_CONTENT" > /tmp/docker-compose.yml

      - name: DEBUG print compose file
        run: cat /tmp/docker-compose.yml

      # -------------------------------------------------------------------
      # 3. Deploy to AWS EC2 Instance via SSH/SCP
      # -------------------------------------------------------------------

      - name: Setup SSH Agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add remote server to known_hosts
        run: ssh-keyscan -H ${{ secrets.AWS_EC2_HOST }} >> ~/.ssh/known_hosts

      - name: SCP updated compose file to remote directory
        run: |
          REMOTE_DIR="/home/${{ secrets.AWS_EC2_USER }}/esp32-smart-home"
          ssh ${{ secrets.AWS_EC2_USER }}@${{ secrets.AWS_EC2_HOST }} "mkdir -p $REMOTE_DIR"
          scp /tmp/docker-compose.yml ${{ secrets.AWS_EC2_USER }}@${{ secrets.AWS_EC2_HOST }}:$REMOTE_DIR/docker-compose.yml

      # -------------------------------------------------------------------
      # 4. SSH into EC2 and run docker-compose with .env injection
      # -------------------------------------------------------------------
      - name: Docker Compose Down/Up via SSH (Passing ENV VARS)
        run: |
          ssh ${{ secrets.AWS_EC2_USER }}@${{ secrets.AWS_EC2_HOST }} << 'EOF'
          REMOTE_DIR="/home/${{ secrets.AWS_EC2_USER }}/esp32-smart-home"
          cd $REMOTE_DIR
          
          cat <<-EOF_ENV > .env
          AWS_IOT_ENDPOINT=${{ secrets.AWS_IOT_ENDPOINT }}
          DDB_TABLE=${{ secrets.DDB_TABLE }}
          AWS_REGION=${{ secrets.AWS_REGION }}
          AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_CERT_PEM='${{ secrets.AWS_CERT_PEM }}'
          AWS_PRIVATE_KEY_PEM='${{ secrets.AWS_PRIVATE_KEY_PEM }}'
          AWS_ROOT_CA_PEM='${{ secrets.AWS_ROOT_CA_PEM }}'
          EOF_ENV

          sudo docker-compose down
          sudo docker-compose pull
          sudo docker-compose up -d
          EOF
