name: CI/CD Pipeline (Pass Env Vars Remotely)

on:
  push:
    branches:
      - main
    paths:
      - 'http-server/**'
      - 'docker/docker-compose.yml'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # (Steps 1 & 2 remain the same: Build, Push, and Prepare the local compose file)

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Set dynamic image tag
        run: echo "TAG=v1.0.${{ github.run_number }}" >> $GITHUB_ENV

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./http-server
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/esp32-smart-home:${{ env.TAG }}

      - name: Prepare updated compose file content
        id: prepare_compose
        run: |
          COMPOSE_CONTENT=$(cat docker/docker-compose.yml | sed "s|olymahmudmugdho/esp32-smart-home:.*|${{ secrets.DOCKERHUB_USERNAME }}/esp32-smart-home:${{ env.TAG }}|g")
          echo "$COMPOSE_CONTENT" > /tmp/docker-compose.yml

      # --- 3. Deploy to AWS EC2 Instance via SSH/SCP ---

      - name: Setup SSH Agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add remote server to known_hosts
        run: ssh-keyscan -H ${{ secrets.AWS_EC2_HOST }} >> ~/.ssh/known_hosts

      - name: SCP updated compose file to remote directory
        run: |
          REMOTE_DIR="/home/${{ secrets.AWS_EC2_USER }}/esp32-smart-home"
          ssh ${{ secrets.AWS_EC2_USER }}@${{ secrets.AWS_EC2_HOST }} "mkdir -p $REMOTE_DIR"
          scp /tmp/docker-compose.yml ${{ secrets.AWS_EC2_USER }}@${{ secrets.AWS_EC2_HOST }}:$REMOTE_DIR/docker-compose.yml

      - name: Docker Compose Down/Up via SSH (Passing ENV VARS)
        run: |
          ssh ${{ secrets.AWS_EC2_USER }}@${{ secrets.AWS_EC2_HOST }} << 'EOF'
          REMOTE_DIR="/home/${{ secrets.AWS_EC2_USER }}/esp32-smart-home"
          cd $REMOTE_DIR
          
          # ðŸ›‘ CRITICAL STEP: Write a temporary .env file on the remote machine
          # The EOF marker with a dash "EOF-" is used to ignore leading tabs/spaces in the script
          cat <<-EOF_ENV > .env
          AWS_IOT_ENDPOINT=${{ secrets.AWS_IOT_ENDPOINT }}
          DDB_TABLE=${{ secrets.DDB_TABLE }}
          AWS_REGION=${{ secrets.AWS_REGION }}
          AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
          # The multi-line PEM contents are passed here within single quotes to preserve newlines
          AWS_CERT_PEM='${{ secrets.AWS_CERT_PEM }}'
          AWS_PRIVATE_KEY_PEM='${{ secrets.AWS_PRIVATE_KEY_PEM }}'
          AWS_ROOT_CA_PEM='${{ secrets.AWS_ROOT_CA_PEM }}'
          EOF_ENV

          # Stop currently running containers
          sudo docker compose down
          
          # Pull the newly updated image tag from Docker Hub
          sudo docker compose pull
          
          # Start the containers using the new configuration. 
          # Docker Compose automatically reads from the .env file in the current directory.
          sudo docker compose up -d
          
          # Optional: Clean up the sensitive .env file after startup if desired for security
          # rm .env
          EOF
